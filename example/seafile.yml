- hosts:        seafile
  gather_facts: true
  remote_user:  root
  pre_tasks:
  - name:       provision ssl dir
    file:
      dest:     /etc/ssl/private
      state:    directory
      owner:    root
      group:    root
      mode:     0700

  - name:       copy ssl certificates
    copy:
      src:      files/ssl/{{ item }}
      dest:     /etc/ssl/private/{{ item }}
      owner:    root
      group:    root
      mode:     0600
    with_items:
    - server.key.pem
    - server.crt.pem


  roles:
    - role:     bennojoy.mysql
    - role:     Ginsys.seafile
    - role:     Ginsys.nginx


  post_tasks:
  - name:       allow web server access to seafile data
    user:
      name:     'www-data'
      groups:   '{{ seafile_user }}'
      append:   yes

  - name:       provision and link customisation directories
    sudo:       yes
    sudo_user:  '{{ seafile_user }}'
    file:
      dest:     '{{ item.dest }}'
      state:    '{{ item.state }}'
      src:      '{{ item.src }}'
      owner:    '{{ seafile_user }}'
      group:    '{{ seafile_user }}'
      mode:     0755
      force:    yes
    with_items:
    - dest:     '{{ seafile_org_dir }}/custom/media'
      state:    directory
      src:
    - dest:     '{{ seafile_org_dir }}/custom/templates'
      state:    directory
      src:
    - src:      '{{ seafile_org_dir }}/custom/media'
      dest:     '{{ seafile_latest_dir }}/seahub/media/custom'
      state:    link
    - src:      '{{ seafile_org_dir }}/custom'
      dest:     '{{ seafile_seahubdata_dir }}/custom'
      state:    link

  - name:       copy customisation files
    sudo:       yes
    sudo_user:  '{{ seafile_user }}'
    copy:
      src:              'files/seafile/custom'
      dest:             '{{ seafile_seahubdata_dir }}/'
      force:            yes
      owner:            '{{ seafile_user }}'
      group:            '{{ seafile_user }}'
      mode:             0644
      directory_mode:   0755

